<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Dinosaurio Chrome V2</title>

  <!-- Tus estilos -->
  <link rel="stylesheet" href="styles.css">

  <!-- Estilos m√≠nimos del QUIZ (igual que ten√≠as) -->
  <style>
    .quiz-overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:10000;padding:max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right)) max(14px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left));backdrop-filter:blur(2px)}
    .quiz-overlay.show{display:grid}
    .quiz-card{width:min(720px,92vw);border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.86));border:1px solid rgba(0,0,0,.08);box-shadow:0 20px 60px rgba(0,0,0,.35);color:#111;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;padding:clamp(16px,4.5vw,28px)}
    .quiz-title{font-size:clamp(18px,5vw,26px);font-weight:900;margin:0 0 8px;color:#2b2b2b;text-align:center}
    .quiz-sub{text-align:center;margin:0 0 16px;color:#475569;font-size:clamp(13px,3.3vw,16px)}
    .quiz-q{font-weight:800;font-size:clamp(15px,4vw,18px);margin:0 0 8px}
    .quiz-options{display:grid;gap:10px;margin:12px 0 8px}
    .quiz-opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border-radius:12px;background:#f3f4f6;border:1px solid #e5e7eb}
    .quiz-opt input{margin-top:4px}
    .quiz-actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
    .btn-primary{appearance:none;border:0;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:900;color:#fff;background:linear-gradient(135deg,#00c9b7,#9b5cf9);box-shadow:0 10px 26px rgba(155,92,249,.35);min-width:180px;font-size:clamp(14px,3.6vw,16px)}
    .btn-secondary{appearance:none;border:0;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:800;color:#334155;background:#e5e7eb;min-width:140px;font-size:clamp(14px,3.4vw,16px)}
    .quiz-msg{text-align:center;margin-top:8px;font-weight:700}
    .quiz-msg.ok{color:#059669}.quiz-msg.err{color:#dc2626}
  </style>
</head>
<body>

  <!-- Franja de logos (flex; sin absolute) -->
  <div class="logos">
    <img src="./Logo-Ag-14.png"       alt="Agencia Digital" class="logo">
    <img src="./logo-much-nuevo1.png" alt="MUCH"            class="logo logo-mid"> <!-- opcional -->
    <img src="./logo-sata.png"        alt="SATA"            class="logo">
  </div>

  <!-- Contenedor del juego -->
  <div class="contenedor" id="game">
    <div class="stage">
      <div class="suelo"></div>
      <div class="dino dino-corriendo"></div>
      <div class="score">0</div>

      <!-- GAME OVER debe ir dentro para que se centre y no ‚Äúflote‚Äù -->
      <div class="game-over">GAME OVER</div>
    </div>
  </div>

  <!-- Bot√≥n de reintento -->
  <div class="retry-wrap" id="retryWrap">
    <button class="btn-retry" id="btnRetry">üîÅ Intentar de nuevo</button>
  </div>

  <!-- QUIZ -->
  <div id="quizOverlay" class="quiz-overlay" aria-hidden="true">
    <div class="quiz-card" role="dialog" aria-modal="true" aria-labelledby="quizTitle">
      <h3 id="quizTitle" class="quiz-title"></h3>
      <p id="quizSub" class="quiz-sub"></p>
      <p id="quizQuestion" class="quiz-q"></p>
      <div id="quizOptions" class="quiz-options"></div>
      <div class="quiz-actions">
        <button id="btnQuizOk" class="btn-primary">Confirmar</button>
        <button id="btnQuizCancel" class="btn-secondary">Cancelar</button>
      </div>
      <div id="quizMsg" class="quiz-msg" aria-live="polite"></div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="jumpSound" src="jump.mp3" preload="auto"></audio>

  <!-- ========= TU L√ìGICA DEL JUEGO (sin cambios) ========= -->
  <script>
    (function(){
      var qp = new URLSearchParams(location.search);
      if (qp.get('start') !== '1') location.replace('portada.html');
    })();

    var time = new Date(), deltaTime = 0;
    if(document.readyState === "complete" || document.readyState === "interactive"){ setTimeout(Init, 1); }
    else { document.addEventListener("DOMContentLoaded", Init); }

    function Init(){ time = new Date(); Start(); Loop(); }
    function Loop(){ deltaTime = (new Date() - time)/1000; time = new Date(); Update(); requestAnimationFrame(Loop); }

    //****** GAME LOGIC ********//
    var sueloY=22, velY=0, impulso=900, gravedad=2500;
    var dinoPosX=42, dinoPosY=sueloY;
    var sueloX=0, velEscenario=1280/3, gameVel=1, score=0;
    var parado=false, saltando=false;
    var tiempoHastaObstaculo=2, tiempoObstaculoMin=0.7, tiempoObstaculoMax=1.8, obstaculoPosY=16, obstaculos=[];
    var tiempoHastaNube=0.5, tiempoNubeMin=0.7, tiempoNubeMax=2.7, maxNubeY=270, minNubeY=100, nubes=[], velNube=0.5;

    var contenedor, dino, textoScore, suelo, gameOver;
    var WIN_SCORE = 10;

    var jumpSound;

    var quizData = null;
    var quizAnswerIndex = null;
    var quizVisible = false;

    function Start() {
      gameOver   = document.querySelector(".game-over");
      suelo      = document.querySelector(".suelo");
      contenedor = document.querySelector(".contenedor");
      textoScore = document.querySelector(".score");
      dino       = document.querySelector(".dino");
      jumpSound  = document.getElementById("jumpSound");

      document.addEventListener("keydown", HandleKeyDown);
      contenedor.addEventListener('click', Saltar);
      contenedor.addEventListener('touchstart', function(e){ e.preventDefault(); Saltar(); }, { passive:false });
      window.addEventListener('pointerdown', GlobalTap, { passive:false });

      document.getElementById('btnRetry').addEventListener('click', function(){
        location.reload();
      });

      document.getElementById('btnQuizOk').addEventListener('click', validarQuiz);
      document.getElementById('btnQuizCancel').addEventListener('click', function(){ cerrarQuiz(); });

      cargarQuizJSON();

      window.addEventListener('blur', antiCheatGuard, {passive:true});
      document.addEventListener('visibilitychange', function(){ if(document.hidden) antiCheatGuard(); });
      window.addEventListener('pagehide', antiCheatGuard, {passive:true});

      document.addEventListener('keydown', blockShortcutsDuringQuiz, {capture:true});
      document.addEventListener('contextmenu', function(e){ if(quizVisible) e.preventDefault(); });
    }

    async function cargarQuizJSON(){
      try{
        const res = await fetch('quiz.json?cb=' + Date.now());
        const data = await res.json();
        const list = Array.isArray(data.questions) ? data.questions : [];
        quizData = list.length ? list[Math.floor(Math.random()*list.length)] : null;
      }catch(e){
        quizData = null;
      }
    }

    function GlobalTap(e){
      if (parado || quizVisible) return;
      var target = e.target;
      if (target.closest('#retryWrap') || target.closest('#quizOverlay')) return;
      var tag = (target.tagName || '').toLowerCase();
      if (tag === 'button' || tag === 'a') return;
      if (e && typeof e.preventDefault === 'function') e.preventDefault();
      Saltar();
    }

    function Update(){
      if(parado) return;
      MoverDinosaurio(); MoverSuelo();
      DecidirCrearObstaculos(); DecidirCrearNubes();
      MoverObstaculos(); MoverNubes(); DetectarColision();
      velY -= gravedad * deltaTime;
    }

    function HandleKeyDown(ev){
      if (quizVisible) return;
      if (ev.code === 'Space' || ev.keyCode === 32 || ev.code === 'ArrowUp' || ev.keyCode === 38){
        ev.preventDefault(); Saltar();
      }
    }

    function Saltar(){
      if(dinoPosY===sueloY){
        saltando=true; velY=impulso; dino.classList.remove("dino-corriendo");
        if(jumpSound){ jumpSound.currentTime=0; jumpSound.play().catch(()=>{}); }
      }
    }

    function MoverDinosaurio(){ dinoPosY += velY*deltaTime; if(dinoPosY<sueloY){ TocarSuelo(); } dino.style.bottom=dinoPosY+"px"; }
    function TocarSuelo(){ dinoPosY=sueloY; velY=0; if(saltando){ dino.classList.add("dino-corriendo"); } saltando=false; }
    function MoverSuelo(){ sueloX += velEscenario*deltaTime*gameVel; suelo.style.left = -(sueloX % contenedor.clientWidth)+"px"; }

    function Estrellarse(){ dino.classList.remove("dino-corriendo"); dino.classList.add("dino-estrellado"); parado=true; }

    function DecidirCrearObstaculos(){ tiempoHastaObstaculo -= deltaTime; if(tiempoHastaObstaculo<=0) CrearObstaculo(); }
    function DecidirCrearNubes(){ tiempoHastaNube -= deltaTime; if(tiempoHastaNube<=0) CrearNube(); }

    function CrearObstaculo(){
      var o=document.createElement("div"); contenedor.appendChild(o); o.classList.add("cactus");
      if(Math.random()>0.5) o.classList.add("cactus2");
      o.posX=contenedor.clientWidth; o.style.left=o.posX+"px";
      obstaculos.push(o);
      tiempoHastaObstaculo = tiempoObstaculoMin + Math.random()*(tiempoObstaculoMax-tiempoObstaculoMin)/gameVel;
    }

    function CrearNube(){
      var n=document.createElement("div"); contenedor.appendChild(n); n.classList.add("nube");
      n.posX=contenedor.clientWidth; n.style.left=n.posX+"px"; n.style.bottom = minNubeY + Math.random()*(maxNubeY-minNubeY)+"px";
      nubes.push(n);
      tiempoHastaNube = tiempoNubeMin + Math.random()*(tiempoNubeMax-tiempoNubeMin)/gameVel;
    }

    function MoverObstaculos(){
      for (var i=obstaculos.length-1;i>=0;i--){
        if(obstaculos[i].posX < -obstaculos[i].clientWidth){
          obstaculos[i].parentNode.removeChild(obstaculos[i]); obstaculos.splice(i,1); GanarPuntos();
        }else{
          obstaculos[i].posX -= velEscenario*deltaTime*gameVel; obstaculos[i].style.left=obstaculos[i].posX+"px";
        }
      }
    }

    function MoverNubes(){
      for (var i=nubes.length-1;i>=0;i--){
        if(nubes[i].posX < -nubes[i].clientWidth){
          nubes[i].parentNode.removeChild(nubes[i]); nubes.splice(i,1);
        }else{
          nubes[i].posX -= velEscenario*deltaTime*gameVel*velNube; nubes[i].style.left=nubes[i].posX+"px";
        }
      }
    }

    function GanarPuntos(){
      score++; textoScore.innerText = score;
      if(score==5){ gameVel=1.5; contenedor.classList.add("mediodia"); }
      else if(score==15){ gameVel=2; contenedor.classList.add("tarde"); }
      else if(score==WIN_SCORE){
        gameVel=3; contenedor.classList.add("noche");
        parado=true; dino.classList.remove("dino-corriendo");
        mostrarQuiz();
        return;
      }
      suelo.style.animationDuration = (3/gameVel)+"s";
    }

    function GameOver(){
      Estrellarse(); gameOver.style.display="grid"; /* grid para centrar */
      var wrap=document.getElementById('retryWrap'); if(wrap) wrap.classList.add('show');
      try{ window.scrollTo({top:0,behavior:'smooth'}); }catch(e){}
    }

    function DetectarColision(){
      for (var i=0;i<obstaculos.length;i++){
        if(obstaculos[i].posX > dinoPosX + dino.clientWidth) break;
        if(IsCollision(dino, obstaculos[i], 10, 30, 15, 20)) GameOver();
      }
    }

    function IsCollision(a,b,pt,pr,pb,pl){
      var A=a.getBoundingClientRect(), B=b.getBoundingClientRect();
      return !(((A.top + A.height - pb) < B.top) || (A.top + pt > (B.top + B.height)) || ((A.left + A.width - pr) < B.left) || (A.left + pl > (B.left + B.width)));
    }

    function mostrarQuiz(){
      if(!quizData){
        quizData = {
          title: "¬°Muy bien! Antes de reclamar tu premio‚Ä¶",
          subtitle: "Responde esta pregunta sobre el museo para continuar:",
          question: "¬øEn qu√© espacio de un museo de ciencia puedes observar el cielo y aprender sobre constelaciones?",
          options: ["Pinacoteca","Auditorio","Cafeter√≠a","Planetario"],
          answerIndex: 3
        };
      }
      document.getElementById('quizTitle').textContent   = quizData.title || "Pregunta final";
      document.getElementById('quizSub').textContent     = quizData.subtitle || "";
      document.getElementById('quizQuestion').textContent= quizData.question || "";

      var box = document.getElementById('quizOptions'); box.innerHTML = "";
      quizAnswerIndex = Number(quizData.answerIndex) || 0;

      (quizData.options||[]).forEach(function(txt, i){
        var id = "q1_"+i;
        var label = document.createElement('label');
        label.className = "quiz-opt";
        label.innerHTML = '<input type="radio" name="q1" value="'+i+'" id="'+id+'"> <span>'+txt+'</span>';
        box.appendChild(label);
      });

      var o = document.getElementById('quizOverlay');
      var msg = document.getElementById('quizMsg'); msg.textContent=""; msg.className="quiz-msg";
      o.classList.add('show');
      quizVisible = true;

      setTimeout(function(){ document.getElementById('btnQuizOk').focus(); }, 20);
      try{ window.scrollTo({top:0,behavior:'smooth'}); }catch(e){}
    }

    function cerrarQuiz(){
      document.getElementById('quizOverlay').classList.remove('show');
      quizVisible = false;
      parado=false; dino.classList.add('dino-corriendo'); time=new Date();
    }

    function validarQuiz(){
      var msg = document.getElementById('quizMsg');
      var sel = document.querySelector('input[name="q1"]:checked');
      if(!sel){ msg.textContent='Selecciona una opci√≥n üòâ'; msg.className='quiz-msg err'; return; }
      if(Number(sel.value) === quizAnswerIndex){
        msg.textContent='¬°Correcto! Vamos a registrar tu premio.'; msg.className='quiz-msg ok';
        setTimeout(function(){ window.location.href='registro.html'; }, 600);
      }else{
        msg.textContent='Respuesta incorrecta. Intenta de nuevo.'; msg.className='quiz-msg err';
      }
    }

    function antiCheatGuard(){
      if (!quizVisible) return;
      try { document.getElementById('quizOverlay').classList.remove('show'); } catch(e){}
      location.replace('portada.html');
    }

    function blockShortcutsDuringQuiz(e){
      if (!quizVisible) return;
      const k = (e.key || '').toLowerCase();
      const isMod = e.ctrlKey || e.metaKey;
      if ((isMod && ['l','t','n','w','k','p','r'].includes(k)) || k === 'f1'){
        e.preventDefault(); e.stopPropagation(); return false;
      }
    }
  </script>
</body>
</html>
